#+TITLE: Phase 5: Extract Parse Module
#+PROPERTY: PHASE 5
#+PROPERTY: RISK Medium
#+PROPERTY: SESSIONS 2

* Objective

Extract all org-element parsing functions to =org-gantt-parse.el=. These
functions convert org headlines into the internal =gantt-info= hash table
representation.

* Key Challenge

The =org-gantt-create-gantt-info= function reads from =org-gantt-options= global.
It needs to accept options as a parameter.

* Prompt for Claude Code

#+begin_src markdown
## Task: Extract Parse Functions to org-gantt-parse.el

Create `org-gantt-parse.el` containing functions that parse org-mode elements
into the internal gantt-info representation.

### Functions to Extract:

**Group 1: Planning time extraction**

1. `org-gantt-get-planning-time` (line ~291) → `org-gantt-parse-planning-time`
   - Extracts SCHEDULED/DEADLINE timestamps from headlines
   - Change: Accept hours-per-day as parameter (currently uses global)

**Group 2: Headline traversal**

2. `org-gantt-get-subheadlines` (line ~310) → `org-gantt-parse-subheadlines`
   - Gets child headlines of an element
   - No change needed (pure function)

**Group 3: Time extraction (recursive)**

3. `org-gantt-get-start-time` (line ~361) → `org-gantt-parse-start-time`
   - Gets start time from headline or recursively from children
   - No change needed

4. `org-gantt-get-end-time` (line ~372) → `org-gantt-parse-end-time`
   - Gets end time from headline or recursively from children
   - No change needed

5. `org-gantt-subheadline-extreme` (line ~330) → `org-gantt-parse-subheadline-extreme`
   - Finds min/max timestamp among subheadlines
   - No change needed

**Group 4: Effort extraction**

6. `org-gantt-get-effort` (line ~410) → `org-gantt-parse-effort`
   - Extracts effort from headline
   - No change needed (passes through to time module)

7. `org-gantt-subheadlines-effort` (line ~393) → `org-gantt-parse-subheadlines-effort`
   - Sums effort of child headlines
   - No change needed

**Group 5: Property extraction**

8. `org-gantt-statistics-value` (line ~444) → `org-gantt-parse-statistics-value`
   - Extracts [X%] or [X/Y] from title
   - No change needed

9. `org-gantt-get-flattened-properties` (line ~447) → `org-gantt-parse-flattened-properties`
   - Flattens multiple property values into list
   - No change needed

**Group 6: ID and gantt-info creation**

10. `org-gantt-create-id` (line ~468) → DELETE (use org-gantt-context-next-id)

11. `org-gantt-create-gantt-info` (line ~475) → `org-gantt-parse-create-info`
    - Main function creating gantt-info hash from headline
    - CRITICAL CHANGE: Accept context as parameter
    - Use context for ID generation and options access

**Group 7: Tree crawling**

12. `org-gantt-crawl-headlines` (line ~514) → `org-gantt-parse-crawl-headlines`
    - Recursively process headline tree
    - CHANGE: Accept context as parameter

**Group 8: Extrema finding in info lists**

13. `org-gantt-get-extreme-date-il` (line ~520) → `org-gantt-parse-extreme-date`
    - Finds earliest/latest date in info list
    - No change needed

### File Structure:

```elisp
;;; org-gantt-parse.el --- Org headline parsing for org-gantt -*- lexical-binding: t -*-

;; Copyright (C) 2025 [Author]

;;; Commentary:
;;
;; Functions for parsing org-mode headlines into gantt-info structures.
;;
;; A gantt-info is a hash table containing:
;; - :name - headline text
;; - :startdate - start time (Emacs time or nil)
;; - :enddate - end time (Emacs time or nil)  
;; - :effort - effort as Emacs time
;; - :clocksum - clocked time as Emacs time
;; - :progress - completion percentage
;; - :stats-cookie - raw statistics cookie string
;; - :tags - list of tags
;; - :parent-tags - tags inherited from parents
;; - :id - unique identifier
;; - :linked-to - list of linked element IDs
;; - :ordered - whether children are ordered
;; - :subelements - list of child gantt-info structures

;;; Code:

(require 'cl-lib)
(require 'org-element)
(require 'org-gantt-config)
(require 'org-gantt-context)
(require 'org-gantt-util)
(require 'org-gantt-time)

;;; Planning Time Extraction

(defun org-gantt-parse-planning-time (element timestamp-type hours-per-day)
  "Get planning time from ELEMENT.
TIMESTAMP-TYPE is :scheduled or :deadline.
HOURS-PER-DAY is used to adjust deadline times that are at midnight."
  ;; [Adapted from org-gantt-get-planning-time]
  ...)

;;; Headline Traversal

(defun org-gantt-parse-subheadlines (element)
  "Get all direct child headlines of ELEMENT."
  (org-element-map element 'headline 
    (lambda (subelement) subelement)
    nil nil 'headline))

;;; Recursive Time Extraction

(defun org-gantt-parse-start-time (element hours-per-day)
  "Get start time of ELEMENT.
Returns scheduled time if present, otherwise earliest child start.
HOURS-PER-DAY is passed through for time calculations."
  ...)

(defun org-gantt-parse-end-time (element hours-per-day)
  "Get end time of ELEMENT.
Returns deadline time if present, otherwise latest child end.
HOURS-PER-DAY is passed through for time calculations."
  ...)

;;; Gantt-Info Creation

(defun org-gantt-parse-create-info (element ctx)
  "Create gantt-info hash table from ELEMENT.
CTX is the org-gantt-context providing options and ID generation."
  (let ((info (make-hash-table)))
    (puthash :name 
             (org-element-property :raw-value element)
             info)
    (puthash :ordered 
             (org-element-property :ORDERED element) 
             info)
    (puthash org-gantt-start-prop 
             (org-gantt-parse-start-time element 
                                        (org-gantt-context-hours-per-day ctx))
             info)
    (puthash org-gantt-end-prop
             (org-gantt-parse-end-time element
                                      (org-gantt-context-hours-per-day ctx))
             info)
    ;; ... rest of properties ...
    (puthash org-gantt-id-prop
             (or (org-element-property :ID element)
                 (org-gantt-context-next-id ctx))
             info)
    (puthash :subelements
             (org-gantt-parse-crawl-headlines (cdr element) ctx)
             info)
    info))

(defun org-gantt-parse-crawl-headlines (data ctx)
  "Parse headline tree in DATA, returning list of gantt-info.
CTX is the org-gantt-context."
  (org-element-map data 'headline
    (lambda (hl) (org-gantt-parse-create-info hl ctx))
    nil nil 'headline))

(provide 'org-gantt-parse)
;;; org-gantt-parse.el ends here
```

### Critical Points:

1. **Context threading**: `org-gantt-parse-create-info` and 
   `org-gantt-parse-crawl-headlines` must accept context parameter

2. **ID generation**: Use `(org-gantt-context-next-id ctx)` instead of 
   the old global counter

3. **Options access**: Use `(org-gantt-context-get-option ctx :key)` 
   instead of `(plist-get org-gantt-options :key)`

4. **Hours-per-day**: Use `(org-gantt-context-hours-per-day ctx)`
   instead of calling the old global accessor

### After Creating the Module:

Update org-gantt.el:
1. Add `(require 'org-gantt-parse)`
2. Create compatibility wrappers
#+end_src

* Verification Steps

** Step 1: Verify file exists

#+begin_src bash
test -f org-gantt-parse.el && echo "File exists" || echo "MISSING"
#+end_src

** Step 2: Count functions

#+begin_src bash
grep -c "^(defun org-gantt-parse-" org-gantt-parse.el
#+end_src

Expected: At least 12 functions

** Step 3: Verify context usage

#+begin_src bash
# Should find context parameter usage
grep "org-gantt-context" org-gantt-parse.el | head -5
# Should NOT find global state access
grep -E "org-gantt-options|org-gant-hours-per-day-gv|\*org-gantt-id-counter\*" org-gantt-parse.el
#+end_src

Expected: Context usage found, no global access

** Step 4: Byte-compile

#+begin_src bash
emacs -batch -L . -f batch-byte-compile org-gantt-parse.el
#+end_src

** Step 5: Run tests

#+begin_src bash
emacs -batch -L . -L test -l ert \
      -l test/org-gantt-parse-test.el \
      -f ert-run-tests-batch-and-exit
#+end_src

** Step 6: Regression

#+begin_src bash
make regression
#+end_src

* Test File: test/org-gantt-parse-test.el

#+begin_src emacs-lisp
;;; org-gantt-parse-test.el --- Tests for org-gantt-parse -*- lexical-binding: t -*-

;;; Code:

(require 'ert)
(require 'org-gantt-parse)
(require 'org-gantt-context)

(defun org-gantt-test-make-context ()
  "Create a test context."
  (let ((ctx (org-gantt-context-init 8 '(0 6))))
    (setf (org-gantt-context-options ctx)
          '(:milestone-tags ("milestone")
            :linked-to-property-keys (:LINKED-TO)))
    ctx))

(defun org-gantt-test-parse-string (org-string)
  "Parse ORG-STRING and return the parsed buffer."
  (with-temp-buffer
    (insert org-string)
    (org-mode)
    (org-element-parse-buffer)))

;;; Subheadline Tests

(ert-deftest org-gantt-parse-test-subheadlines ()
  "Test getting subheadlines."
  (let* ((org-string "* Parent\n** Child 1\n** Child 2\n** Child 3\n")
         (parsed (org-gantt-test-parse-string org-string))
         (parent (car (org-element-map parsed 'headline #'identity)))
         (children (org-gantt-parse-subheadlines (cdr parent))))
    (should (= 3 (length children)))))

(ert-deftest org-gantt-parse-test-subheadlines-empty ()
  "Test getting subheadlines when there are none."
  (let* ((org-string "* Leaf\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (children (org-gantt-parse-subheadlines (cdr headline))))
    (should (= 0 (length children)))))

;;; Time Extraction Tests

(ert-deftest org-gantt-parse-test-start-time-scheduled ()
  "Test extracting scheduled time."
  (let* ((org-string "* Task\nSCHEDULED: <2025-01-06 Mon>\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (start-time (org-gantt-parse-start-time headline 8)))
    (should start-time)
    (let ((decoded (decode-time start-time)))
      (should (= 6 (nth 3 decoded)))   ; day
      (should (= 1 (nth 4 decoded)))   ; month
      (should (= 2025 (nth 5 decoded)))))) ; year

(ert-deftest org-gantt-parse-test-end-time-deadline ()
  "Test extracting deadline time."
  (let* ((org-string "* Task\nDEADLINE: <2025-01-10 Fri>\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (end-time (org-gantt-parse-end-time headline 8)))
    (should end-time)
    (let ((decoded (decode-time end-time)))
      (should (= 10 (nth 3 decoded)))
      ;; Note: deadline at midnight gets hours-per-day added
      (should (= 8 (nth 2 decoded))))))

(ert-deftest org-gantt-parse-test-time-from-children ()
  "Test time extraction falling back to children."
  (let* ((org-string "* Parent\n** Child\nSCHEDULED: <2025-01-06 Mon>\n")
         (parsed (org-gantt-test-parse-string org-string))
         (parent (car (org-element-map parsed 'headline #'identity)))
         (start-time (org-gantt-parse-start-time parent 8)))
    ;; Should get time from child since parent has none
    (should start-time)))

;;; Statistics Cookie Tests

(ert-deftest org-gantt-parse-test-statistics-percent ()
  "Test parsing percentage statistics cookie."
  (let* ((org-string "* Task [75%]\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (title (org-element-property :title headline))
         (cookie (org-gantt-parse-statistics-value title)))
    (should (string= "[75%]" cookie))))

(ert-deftest org-gantt-parse-test-statistics-fraction ()
  "Test parsing fraction statistics cookie."
  (let* ((org-string "* Task [3/4]\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (title (org-element-property :title headline))
         (cookie (org-gantt-parse-statistics-value title)))
    (should (string= "[3/4]" cookie))))

;;; Gantt-Info Creation Tests

(ert-deftest org-gantt-parse-test-create-info-basic ()
  "Test basic gantt-info creation."
  (let* ((ctx (org-gantt-test-make-context))
         (org-string "* My Task\nSCHEDULED: <2025-01-06 Mon> DEADLINE: <2025-01-10 Fri>\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (info (org-gantt-parse-create-info headline ctx)))
    (should (hash-table-p info))
    (should (string= "My Task" (gethash :name info)))
    (should (gethash org-gantt-start-prop info))
    (should (gethash org-gantt-end-prop info))
    (should (gethash org-gantt-id-prop info))))

(ert-deftest org-gantt-parse-test-create-info-with-effort ()
  "Test gantt-info creation with effort."
  (let* ((ctx (org-gantt-test-make-context))
         (org-string "* Task\n:PROPERTIES:\n:EFFORT: 2d\n:END:\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (info (org-gantt-parse-create-info headline ctx)))
    (should (gethash org-gantt-effort-prop info))))

(ert-deftest org-gantt-parse-test-create-info-with-tags ()
  "Test gantt-info creation preserves tags."
  (let* ((ctx (org-gantt-test-make-context))
         (org-string "* Task :important:urgent:\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (info (org-gantt-parse-create-info headline ctx)))
    (should (member "important" (gethash org-gantt-tags-prop info)))
    (should (member "urgent" (gethash org-gantt-tags-prop info)))))

(ert-deftest org-gantt-parse-test-create-info-id-generation ()
  "Test that IDs are generated correctly."
  (let* ((ctx (org-gantt-test-make-context))
         (org-string "* Task 1\n* Task 2\n* Task 3\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headlines (org-element-map parsed 'headline #'identity))
         (ids (mapcar (lambda (hl)
                       (gethash org-gantt-id-prop 
                               (org-gantt-parse-create-info hl ctx)))
                     headlines)))
    ;; All IDs should be unique
    (should (= 3 (length (delete-dups ids))))))

(ert-deftest org-gantt-parse-test-create-info-preserves-org-id ()
  "Test that explicit :ID property is preserved."
  (let* ((ctx (org-gantt-test-make-context))
         (org-string "* Task\n:PROPERTIES:\n:ID: my-custom-id\n:END:\n")
         (parsed (org-gantt-test-parse-string org-string))
         (headline (car (org-element-map parsed 'headline #'identity)))
         (info (org-gantt-parse-create-info headline ctx)))
    (should (string= "my-custom-id" (gethash org-gantt-id-prop info)))))

;;; Crawl Headlines Tests

(ert-deftest org-gantt-parse-test-crawl-simple ()
  "Test crawling simple headline structure."
  (let* ((ctx (org-gantt-test-make-context))
         (org-string "* Task 1\n* Task 2\n* Task 3\n")
         (parsed (org-gantt-test-parse-string org-string))
         (info-list (org-gantt-parse-crawl-headlines parsed ctx)))
    (should (= 3 (length info-list)))
    (should (hash-table-p (car info-list)))))

(ert-deftest org-gantt-parse-test-crawl-nested ()
  "Test crawling nested headlines."
  (let* ((ctx (org-gantt-test-make-context))
         (org-string "* Parent\n** Child 1\n** Child 2\n* Sibling\n")
         (parsed (org-gantt-test-parse-string org-string))
         (info-list (org-gantt-parse-crawl-headlines parsed ctx)))
    ;; Should have 2 top-level entries
    (should (= 2 (length info-list)))
    ;; First entry should have 2 subelements
    (let ((parent-info (car info-list)))
      (should (= 2 (length (gethash :subelements parent-info)))))))

;;; Extreme Date Tests

(ert-deftest org-gantt-parse-test-extreme-date-earliest ()
  "Test finding earliest date in info list."
  (let* ((ctx (org-gantt-test-make-context))
         (org-string (concat "* Task 1\nSCHEDULED: <2025-01-10 Fri>\n"
                            "* Task 2\nSCHEDULED: <2025-01-05 Sun>\n"
                            "* Task 3\nSCHEDULED: <2025-01-15 Wed>\n"))
         (parsed (org-gantt-test-parse-string org-string))
         (info-list (org-gantt-parse-crawl-headlines parsed ctx))
         (earliest (org-gantt-parse-extreme-date 
                    info-list
                    (lambda (info) (gethash org-gantt-start-prop info))
                    #'org-gantt-util-time-less-p)))
    (should earliest)
    (let ((decoded (decode-time earliest)))
      (should (= 5 (nth 3 decoded))))))  ; Jan 5 is earliest

;;; org-gantt-parse-test.el ends here
#+end_src

* Success Criteria

- [ ] =org-gantt-parse.el= exists with 12+ functions
- [ ] Functions use context parameter instead of globals
- [ ] ID generation uses =org-gantt-context-next-id=
- [ ] File byte-compiles without warnings
- [ ] All parse tests pass
- [ ] Regression test passes

* Next Phase

Once all criteria pass, proceed to [[file:07-phase-propagate.org][Phase 6: Extract Propagation Module]].
