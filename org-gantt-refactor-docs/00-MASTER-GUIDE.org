#+TITLE: org-gantt.el Refactoring: Master Guide for Claude Code
#+AUTHOR: Orchestration Document
#+OPTIONS: toc:t num:t

* Overview

This guide orchestrates the complete refactoring of org-gantt.el into a modular
architecture using Claude Code (Sonnet 4.5). Each phase has:

1. A prompt file to give Claude Code
2. Verification tests to run before proceeding
3. Success criteria that must pass

* Prerequisites

Before starting, ensure you have:

1. The original =org-gantt.el= file (working version)
2. A test org file with known-good output (see =test-fixtures/sample-gantt.org=)
3. Git repository initialized with clean working tree
4. Emacs available for running ERT tests

* Directory Structure

After refactoring, your directory should look like:

#+begin_example
org-gantt/
├── org-gantt.el              # Backward-compatible entry point (requires all modules)
├── org-gantt-config.el       # Configuration (defcustom, defconst)
├── org-gantt-context.el      # Context struct definition
├── org-gantt-util.el         # Pure utility functions
├── org-gantt-time.el         # Time/date calculations
├── org-gantt-parse.el        # Org headline parsing
├── org-gantt-propagate.el    # Date/effort propagation
├── org-gantt-render.el       # PGF/TikZ output generation
├── org-gantt-core.el         # Main entry points
└── test/
    ├── org-gantt-test-runner.el
    ├── org-gantt-util-test.el
    ├── org-gantt-time-test.el
    ├── org-gantt-parse-test.el
    ├── org-gantt-propagate-test.el
    ├── org-gantt-render-test.el
    └── test-fixtures/
        └── sample-gantt.org
#+end_example

* Phase Execution Order

| Phase | File | Risk | Sessions | Depends On |
|-------+------+------+----------+------------|
|     0 | Setup test infrastructure | None |        1 | - |
|     1 | Extract config | Low |        1 | Phase 0 |
|     2 | Create context struct | Low |        1 | Phase 1 |
|     3 | Extract utilities | Low |        1 | Phase 1 |
|     4 | Extract time module | Medium |        2 | Phase 1,2,3 |
|     5 | Extract parse module | Medium |        2 | Phase 1-4 |
|     6 | Extract propagation | High |        3 | Phase 1-5 |
|     7 | Extract render module | Medium |        2 | Phase 1-6 |
|     8 | Refactor core | High |        2 | Phase 1-7 |
|     9 | Integration & cleanup | Medium |        2 | Phase 1-8 |

* Execution Protocol

For each phase:

1. *Commit current state*: =git add -A && git commit -m "Before phase N"=
2. *Run Claude Code* with the phase prompt file
3. *Review output* before accepting changes

** MANDATORY VERIFICATION (DO NOT SKIP)

4. *Byte-compile test*: =emacs -batch -L . -f batch-byte-compile <module>.el=
   - MUST show 0 NEW errors or warnings (existing warnings are acceptable)
   - If new errors/warnings appear: fix them before proceeding

5. *Run unit tests*: =emacs -batch -L . -L test -l ert -l test/<module>-test.el -f ert-run-tests-batch-and-exit=
   - MUST show "X results as expected, 0 unexpected"
   - If ANY tests fail: fix the code, do NOT commit
   - If tests themselves are buggy: fix the tests first

6. *Run regression test*: Verify sample-gantt.org still produces correct output
   - MUST produce identical output to baseline
   - If failing: fix the regression before proceeding

** COMMIT ONLY IF ALL TESTS PASS

7. *Commit if and only if passing*: =git add -A && git commit -m "Complete phase N: <description>"=
   - Commit message must include what was accomplished
   - Do NOT commit if any test is failing

8. *If failing*:
   - Debug and fix the code
   - Re-run all verification steps (4-6)
   - Only commit when everything passes
   - If stuck: =git checkout .= and retry the phase or seek help


* Debugging Test Failures

When a phase's tests fail, follow this systematic approach:

** Step 1: Identify the Failure Type

Test failures can come from three sources:

1. *Test Infrastructure Bugs* - The test harness itself has issues
2. *Code Regressions* - Your changes broke existing functionality
3. *Test Expectations* - Tests need updating for intentional changes

** Step 2: Debug Test Infrastructure First

Before assuming your code changes are wrong, verify the test infrastructure:

#+begin_src bash
# Check if test runner loads properly
emacs -batch -L . -L test -l test/org-gantt-test-runner.el \
      --eval "(message \"Test runner loaded\")"

# Manually run the dynamic block update to see detailed output
emacs -batch -L . --eval "(progn
  (require 'org-gantt)
  (find-file \"test/test-fixtures/sample-gantt.org\")
  (org-mode)
  (org-clock-sum)
  (goto-char (point-min))
  (search-forward \"#+BEGIN: org-gantt-chart\")
  (beginning-of-line)
  (org-update-dblock))"
#+end_src

Common test infrastructure issues:
- Missing =org-clock-sum= call before dynamic block update
- Cursor not positioned at line beginning for =org-update-dblock=
- Incorrect content extraction (boundary off-by-one errors)

** Step 3: Compare Outputs Character-by-Character

If regression test fails, generate actual output and compare:

#+begin_src bash
# Generate current output
emacs -batch -Q -L . --eval "..." > actual-output.tex

# Compare with expected
diff -u test/test-fixtures/expected-output.tex actual-output.tex
#+end_src

** Step 4: Workarounds for Tool Failures

If the Edit tool reports "File has been unexpectedly modified":
- *Option 1*: Re-read the file and try Edit again
- *Option 2*: Use =sed= commands as a fallback:
  #+begin_src bash
  sed -i 'LINE_NUMBER a\NEW_LINE_CONTENT' file.el
  sed -i 'START,ENDd' file.el  # Delete lines
  #+end_src
- *Option 3*: For complex edits, use Write tool to rewrite entire file

** Step 5: Verify Fix Didn't Break Other Things

After fixing test infrastructure:
#+begin_src bash
make regression  # Ensure regression test now passes
make test        # Run all unit tests
#+end_src

** Step 6: Interpreting Byte-Compilation Warnings

Not all byte-compilation warnings indicate problems with your changes:

*Pre-existing warnings* (safe to ignore during refactoring):
- Docstring wider than 80 characters
- Wrong usage of unescaped single quotes in docstrings
- Missing function definitions for org-mode functions (org-element-*, org-clock-sum, etc.)
- Reference to free variables that will be defined later in require chain

*New warnings* (require investigation):
- Undefined functions with org-gantt- prefix
- Wrong number of arguments to org-gantt- functions
- Assignment to free variable (suggests missing parameter)
- Calls to functions not yet defined in dependency order

*Strategy*:
#+begin_src bash
# Capture warnings before your changes
make clean && make compile 2>&1 | tee baseline-warnings.txt

# After your changes, compare
make clean && make compile 2>&1 | tee current-warnings.txt
diff baseline-warnings.txt current-warnings.txt
#+end_src

Only warnings in the diff are your responsibility to fix.
* Quick Reference: Running Tests

#+begin_src bash
# Run all tests for a specific module
emacs -batch -L . -L test -l ert \
      -l test/org-gantt-MODULE-test.el \
      -f ert-run-tests-batch-and-exit

# Run full regression test
emacs -batch -L . -l test/org-gantt-test-runner.el \
      -f org-gantt-run-all-tests

# Run single test
emacs -batch -L . -L test -l ert \
      -l test/org-gantt-MODULE-test.el \
      --eval "(ert-run-tests-batch-and-exit 'TEST-NAME)"
#+end_src

* Rollback Procedures

If a phase fails and you need to rollback:

#+begin_src bash
# Discard all uncommitted changes
git checkout .
git clean -fd

# Or reset to a specific phase
git log --oneline  # Find the commit
git reset --hard COMMIT_HASH
#+end_src

* Prompt Files

Each phase has a corresponding prompt file:

- =01-phase-setup.org= - Test infrastructure setup
- =02-phase-config.org= - Extract configuration
- =03-phase-context.org= - Create context struct  
- =04-phase-util.org= - Extract utilities
- =05-phase-time.org= - Extract time module
- =06-phase-parse.org= - Extract parse module
- =07-phase-propagate.org= - Extract propagation (multiple parts)
- =08-phase-render.org= - Extract render module
- =09-phase-core.org= - Refactor core
- =10-phase-integration.org= - Final integration

* Success Metrics

The refactoring is complete when:

- [ ] All ERT tests pass (target: 50+ tests)
- [ ] =sample-gantt.org= produces identical output to original
- [ ] No global variables except configuration defaults
- [ ] All modules < 400 lines
- [ ] No function > 60 lines
- [ ] All functions have docstrings
- [ ] Byte-compilation produces no warnings
- [ ] =M-x checkdoc= passes on all files
